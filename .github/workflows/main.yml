name: Build Lwarp HTML and Deploy v4

on:
  push:
    branches: ["main"] # Or 'master', change to your default branch
  workflow_dispatch:   # Allows manual trigger

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compile LaTeX to HTML using Docker
        # We use the official TeX Live image which includes lwarp.
        # We mount the current workspace to /data in the container.
        # We explicitly remove staging.html and clean lwarp to ensure a fresh build.
        # ADDED: Installation of poppler-utils via apt-get for image conversion.
        # ADDED: Explicit 'tlmgr option repository' to use a Tier 1 mirror (Utah) to avoid "remote database older" errors.
        run: |
          docker run --rm \
          -v "${{ github.workspace }}:/data" \
          -w /data \
          texlive/texlive:latest \
          /bin/bash -c "apt-get update && apt-get install -y poppler-utils && tlmgr option repository https://ctan.math.utah.edu/ctan/tex-archive/systems/texlive/tlnet && tlmgr install lwarp && rm -f staging.html && lwarpmk clean && lwarpmk html"

      - name: Prepare Site Directory
        run: |
          mkdir -p _site
          
          # Check if the compilation succeeded
          if [ -f staging.html ]; then
            # VITAL FIX: Use sed to find "staging.html" inside the generated file 
            # and replace it with "index.html".
            # This ensures that internal links (anchors, TOC) point to the correct URL.
            sed -i 's/staging\.html/index.html/g' staging.html
            
            # Move the file to _site as index.html so it serves as the homepage
            cp staging.html _site/index.html
          else
            echo "Error: staging.html was not found. Compilation may have failed."
            exit 1
          fi

          # Copy your specific CSS file
          if [ -f super.css ]; then
            cp super.css _site/
          fi

          # Copy lwarp generated assets (lwarp often generates css, images, etc.)
          # Copy lwarp.css if it exists (standard lwarp file)
          [ -f lwarp.css ] && cp lwarp.css _site/
          
          # Copy any generated images folders (usually named 'images' or 'lateximages')
          [ -d images ] && cp -r images _site/
          [ -d lateximages ] && cp -r lateximages _site/
          
          # Create .nojekyll to stop GitHub from ignoring files starting with underscores
          # and to prevent it from trying to compile the HTML as Markdown.
          touch _site/.nojekyll

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './_site'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
